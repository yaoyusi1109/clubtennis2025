---
title: "VT Club Tennis Elo Ranking System"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: show
---

## 1. From Challenge Ladder to Elo: A More Quantitative Approach

### Previous Challenge Ladder System

VT Club Tennis previously used a traditional challenge ladder system with the following rules:

**Challenge Rules (Legacy System):**

1. Everyone on the team must challenge someone at least once a semester (except for the #1 ranked player)
2. If you're ranked inside the top 10, you can challenge someone a maximum of 3 spots above you
3. If you're ranked outside the top 10, you can challenge someone a maximum of 5 spots above you (but cannot challenge past #7)
4. If you're ranked outside the top 20, you can challenge someone a maximum of 7 spots above you (but cannot challenge past #16)
5. All challenge matches are best of 3 sets
6. You may only challenge the same player once a month
7. Injured players are not eligible to compete in challenge matches
8. Please challenge other members via email, copying vtmensclubtennis@gmail.com
9. Players have 48 hours to respond to a challenge
10. The challenge match must be played within 7 days after acceptance

### Why We're Moving to Elo

While the challenge ladder system served us well, we're transitioning to an **Elo rating system** to create a **more quantitative and linear ranking approach**. Here's why:

**Problems with the Traditional System:**
- **Arbitrary restrictions**: Different challenge limits for different ranking tiers created complexity
- **Limited mobility**: Top players were harder to challenge, creating ranking stagnation
- **Binary outcomes**: Win/loss only, no consideration of opponent strength
- **Administrative burden**: Tracking challenge eligibility, timing, and violations required constant oversight

**Benefits of Elo:**
- ✅ **Linear and quantitative**: Everyone has a numerical rating that changes predictably
- ✅ **No artificial barriers**: Any player can play anyone, anytime
- ✅ **Rewards skill-appropriate competition**: Beating stronger players = bigger rating gains
- ✅ **Self-regulating**: No need to track who can challenge whom
- ✅ **Transparent**: Everyone can see exactly how ratings change after each match
- ✅ **Fairer assessment**: Your rating reflects your true skill level over time

---

## 2. What is the Elo Rating System?

Think of Elo like a video game ranking system where everyone starts at the same level. When you win matches, you gain points; when you lose, you lose points. The cool part? **Beating stronger players earns you more points than beating weaker ones.**

### Key Concepts:

- **Everyone starts with an initial rating** (assigned based on current ladder position)
- **Win = gain points, Lose = lose points**
- **Bigger upset = bigger point swing**
- **The system balances itself** - ratings reflect true skill over time

## 3. How Does It Work? (Simple Explanation)

### Step 1: Predict the outcome
Before each match, we calculate who *should* win based on current ratings.

**Example:** Player A (1400 rating) vs Player B (1300 rating)
- Player A is expected to win about 64% of the time
- Player B is expected to win about 36% of the time

### Step 2: Compare prediction to reality
After the match, we see what actually happened and compare it to the prediction.

### Step 3: Adjust ratings
- **If the favorite wins**: Small point change (expected result)
- **If the underdog wins**: Large point change (upset!)

The formula is simple:
```
New Rating = Old Rating + K × (Actual Result - Expected Result)
```

Where:
- **K** = How many points are at stake (32 for new players, 12-24 for experienced players)
- **Actual Result** = 1 if you won, 0 if you lost
- **Expected Result** = Probability you were supposed to win (0 to 1)

## 4. Let's See It In Action: VT Club Tennis Roster Simulation

We'll apply the Elo rating system to the **actual VT Club Tennis men's roster** and simulate a season of matches to see how rankings evolve.

```{r setup}
#| echo: false
#| message: false
#| warning: false

library(dplyr)
library(ggplot2)
library(lubridate)
library(knitr)
library(tidyr)
library(DT)

# VT color palette
vt_maroon <- "#861F41"
vt_orange <- "#E87722"

# Set seed for reproducibility
set.seed(42)
```

### Initial Roster

Here are the 40 members of the VT Club Tennis men's team, starting with their current ladder rankings:

```{r initial-roster}
#| echo: false

# Initialize players with real roster data
players <- tibble(
  Name = c("Mitchell Freeman", "Carson Le", "Diego Beltfort", "Austin Victory", 
           "Luke Howell", "Vaughn Harrington", "Nico Bermudez", "Reed Kelly", 
           "David Cho", "Rodrigo Lopez", "Sarthak Vishwakarma", "Eric Yoo", 
           "Andrew Kim", "Aden Bashir", "Lucas Balcells", "Nicola Cattaneo", 
           "Gus Mitchell", "Harisharan Baskaran", "Alvaro Garcia", "Henry Goings-Perrot", 
           "Cole Frumin", "Hieu Do", "Joshua Padgett", "Sanjay Karikal", 
           "Sage Lin", "Alex Brandon", "Nicolas Goossens", "Gautam Iyer", 
           "Parthiv Ketha", "Pedro Wenzel", "Connor Nicol", "Nam Duong", 
           "Carter Nelson", "Larry Wang", "Sean Stark", "Enrique Rodriguez", 
           "Rohit Pradhan", "Surya Ramvinayak", "Yash Pawnarkar", "Alejandro Lerma"),
  Initial_Rank = 1:40,
  Year = c("Senior", "Junior", "Senior", "Sophomore", "Sophomore", "Sophomore", 
           "Senior", "Senior", "Junior", "Sophomore", "Sophomore", "Grad Student", 
           "Sophomore", "Senior", "Senior", "Freshmen", "Junior", "Freshmen", 
           "Grad Student", "Freshman", "Freshmen", "Senior", "Senior", "Junior", 
           "Junior", "Senior", "Junior", "Senior", "Sophomore", "Junior", 
           "Junior", "Junior", "Freshmen", "Freshmen", "Freshmen", "Freshmen", 
           "Senior", "Freshmen", "Freshmen", "Sophomore"),
  Email = c("mitchellf22@vt.edu", "carsonl31@vt.edu", "dbelfort@vt.edu", "victorya3@vt.edu",
            "lukeh06@vt.edu", "vaughnh24@vt.edu", "nbermudez03@vt.edu", "reedk22@vt.edu",
            "dcho112004@vt.edu", "rodrigojlpz@vt.edu", "sarthakv53@vt.edu", "ericy@vt.edu",
            "andrewk05@vt.edu", "adenbashir2003@vt.edu", "lbalcells@vt.edu", "ncd@vt.edu",
            "gusm5@vt.edu", "harisharanb@vt.edu", "alvarogd25@vt.edu", "henrygp@vt.edu",
            "cfru07@vt.edu", "hieud@vt.edu", "joshuapadgett26@vt.edu", "sanjayk@vt.edu",
            "sagelin27@vt.edu", "alexb04@vt.edu", "nicolas04@vt.edu", "guatamiyer01@vt.edu",
            "kparthiv24@vt.edu", "pedrowenzel@vt.edu", "nconnor04@vt.edu", "namd23@vt.edu",
            "cartern29@vt.edu", "larryw06@vt.edu", "seans06@vt.edu", "nicolasr@vt.edu",
            "rohitp@vt.edu", "suryarv@vt.edu", "yashpaw@vt.edu", "alejandrolerma@vt.edu"),
  # Assign initial Elo ratings based on ladder position
  # Top players get higher starting ratings
  Rating = 1600 - (1:40 - 1) * 10,
  Wins = 0,
  Losses = 0
)

datatable(
  players %>% select(Initial_Rank, Name, Year, Rating),
  options = list(pageLength = 10, scrollX = TRUE),
  caption = "Initial VT Club Tennis Roster with Starting Elo Ratings"
)
```

### Match 1: Alice vs Bob (Both start at 1300)

```{r example-match1}
#| echo: false

# Create 3 example players
example_players <- data.frame(
  name = c("Alice", "Bob", "Charlie"),
  rating = c(1300, 1300, 1300),
  stringsAsFactors = FALSE
)

# Helper function for expected score
calc_expected <- function(rating_a, rating_b) {
  1 / (1 + 10^((rating_b - rating_a) / 400))
}

kable(example_players, caption = "Starting Ratings - Everyone at 1300")
```

**Before Match:**
- Alice: 1300 rating
- Bob: 1300 rating
- Expected Result: 50-50 (both equal)

**Alice wins!**

**Calculation:**
- K-factor: 32 (both are new players)
- Alice expected to win: 0.50 (50%)
- Alice actually won: 1.0 (100%)
- Point change: 32 × (1.0 - 0.50) = **+16 points**

```{r example-match1-result}
#| echo: false

# Alice wins
K <- 32
expected_alice <- calc_expected(1300, 1300)
change <- K * (1 - expected_alice)

example_players$rating[1] <- 1300 + change  # Alice
example_players$rating[2] <- 1300 - change  # Bob

result1 <- data.frame(
  name = c("Alice", "Bob"),
  old_rating = c(1300, 1300),
  expected = c("50%", "50%"),
  actual = c("Won", "Lost"),
  change = c(paste0("+", round(change, 1)), paste0("-", round(change, 1))),
  new_rating = c(round(1300 + change, 1), round(1300 - change, 1))
)

kable(result1, caption = "Match 1 Results")
```

**After Match 1:**

```{r example-standings1}
#| echo: false

standings1 <- example_players %>%
  arrange(desc(rating)) %>%
  mutate(
    rank = row_number(),
    rating = round(rating, 1)
  ) %>%
  select(rank, name, rating)

kable(standings1, caption = "Current Standings After Match 1")
```

---

### Match 2: Alice vs Charlie (Alice now favored)

**Before Match:**
- Alice: 1316 rating (favorite)
- Charlie: 1300 rating (underdog)
- Expected: Alice should win 52% of the time

**Charlie wins! (UPSET)**

**Calculation:**
- K-factor: 32 (both still new)
- Charlie expected to win: 0.48 (48%)
- Charlie actually won: 1.0 (100%)
- Point change: 32 × (1.0 - 0.48) = **+17 points** (more than Match 1 because of the upset!)

```{r example-match2-result}
#| echo: false

expected_charlie <- calc_expected(1300, example_players$rating[1])
change <- K * (1 - expected_charlie)

example_players$rating[3] <- example_players$rating[3] + change  # Charlie
example_players$rating[1] <- example_players$rating[1] - change  # Alice

result2 <- data.frame(
  name = c("Charlie", "Alice"),
  old_rating = c(1300, 1316),
  expected = c("48%", "52%"),
  actual = c("Won", "Lost"),
  change = c(paste0("+", round(change, 1)), paste0("-", round(change, 1))),
  new_rating = c(round(1300 + change, 1), round(1316 - change, 1))
)

kable(result2, caption = "Match 2 Results - Upset!")
```

**After Match 2:**

```{r example-standings2}
#| echo: false

standings2 <- example_players %>%
  arrange(desc(rating)) %>%
  mutate(
    rank = row_number(),
    rating = round(rating, 1)
  ) %>%
  select(rank, name, rating)

kable(standings2, caption = "Current Standings After Match 2")
```

---

### Simulating a Season of Matches

Now let's simulate **200 random matches** to see how the rankings evolve over time. The simulation assumes:

- Players closer in the ladder are more likely to play each other
- Higher-ranked players win more often, but upsets happen
- Every match updates both players' ratings using the Elo formula

```{r simulation}
#| echo: false

# Elo calculation functions
calc_expected <- function(rating_a, rating_b) {
  1 / (1 + 10^((rating_b - rating_a) / 400))
}

update_elo <- function(rating, expected, actual, k = 32) {
  rating + k * (actual - expected)
}

# Initialize match history
match_history <- tibble()
rating_history <- tibble()

# Store initial state
rating_history <- bind_rows(
  rating_history,
  players %>% 
    select(Name, Rating) %>%
    mutate(Match = 0)
)

# Simulate 200 matches
num_matches <- 200
K_FACTOR <- 32

for (i in 1:num_matches) {
  # Select two random players with bias towards closer rankings
  # Higher ranked players have slightly higher chance to play
  player1_idx <- sample(1:40, 1, prob = exp(-((1:40)/10)))
  
  # Player 2 is more likely to be close in ranking to player 1
  distance_weight <- exp(-abs((1:40) - player1_idx) / 8)
  distance_weight[player1_idx] <- 0  # Can't play yourself
  player2_idx <- sample(1:40, 1, prob = distance_weight)
  
  # Get current ratings
  p1_rating <- players$Rating[player1_idx]
  p2_rating <- players$Rating[player2_idx]
  
  # Calculate expected scores
  p1_expected <- calc_expected(p1_rating, p2_rating)
  p2_expected <- calc_expected(p2_rating, p1_rating)
  
  # Determine winner (higher rated player wins more often, but not always)
  p1_wins <- runif(1) < p1_expected
  
  # Update ratings
  p1_actual <- if (p1_wins) 1 else 0
  p2_actual <- if (p1_wins) 0 else 1
  
  old_p1_rating <- p1_rating
  old_p2_rating <- p2_rating
  
  players$Rating[player1_idx] <- update_elo(p1_rating, p1_expected, p1_actual, K_FACTOR)
  players$Rating[player2_idx] <- update_elo(p2_rating, p2_expected, p2_actual, K_FACTOR)
  
  # Update win/loss records
  if (p1_wins) {
    players$Wins[player1_idx] <- players$Wins[player1_idx] + 1
    players$Losses[player2_idx] <- players$Losses[player2_idx] + 1
  } else {
    players$Wins[player2_idx] <- players$Wins[player2_idx] + 1
    players$Losses[player1_idx] <- players$Losses[player1_idx] + 1
  }
  
  # Record match
  match_history <- bind_rows(
    match_history,
    tibble(
      Match = i,
      Player1 = players$Name[player1_idx],
      Player2 = players$Name[player2_idx],
      Winner = if (p1_wins) players$Name[player1_idx] else players$Name[player2_idx],
      P1_Rating_Change = round(players$Rating[player1_idx] - old_p1_rating, 1),
      P2_Rating_Change = round(players$Rating[player2_idx] - old_p2_rating, 1)
    )
  )
  
  # Record ratings every 10 matches for the top 10 players
  if (i %% 10 == 0) {
    rating_history <- bind_rows(
      rating_history,
      players %>% 
        select(Name, Rating) %>%
        mutate(Match = i)
    )
  }
}

# Add final ratings
rating_history <- bind_rows(
  rating_history,
  players %>% 
    select(Name, Rating) %>%
    mutate(Match = num_matches)
)
```

### Final Rankings After 200 Matches

Here's how the ladder looks after the simulation. Notice how some players have moved significantly from their initial positions!

```{r final-rankings}
#| echo: false

final_rankings <- players %>%
  arrange(desc(Rating)) %>%
  mutate(
    Final_Rank = row_number(),
    Rating = round(Rating, 1),
    Change = Final_Rank - Initial_Rank,
    Direction = case_when(
      Change < 0 ~ "▲",
      Change > 0 ~ "▼",
      TRUE ~ "−"
    )
  ) %>%
  select(Final_Rank, Name, Year, Rating, Wins, Losses, Initial_Rank, Change, Direction)

datatable(
  final_rankings,
  options = list(pageLength = 15, scrollX = TRUE),
  caption = "Final Rankings After 200 Simulated Matches"
) %>%
  DT::formatStyle(
    'Change',
    backgroundColor = styleInterval(c(-0.5, 0.5), c('#90EE90', 'white', '#FFB6C6'))
  )
```

### Rating Evolution for Top 10 Players

This chart shows how the ratings of the top 10 players evolved throughout the 200-match season:

```{r rating-evolution}
#| echo: false
#| fig-width: 12
#| fig-height: 7

# Get final top 10 players
top_10_names <- players %>%
  arrange(desc(Rating)) %>%
  slice(1:10) %>%
  pull(Name)

# Filter rating history for top 10
top_10_history <- rating_history %>%
  filter(Name %in% top_10_names)

ggplot(top_10_history, aes(x = Match, y = Rating, color = Name, group = Name)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2, alpha = 0.6) +
  scale_color_manual(values = c(
    rep(c(vt_maroon, vt_orange, "#2E8B57", "#4169E1", "#DC143C"), 2)
  )) +
  labs(
    title = "Rating Evolution of Top 10 Players",
    subtitle = "Tracking Elo ratings across 200 matches",
    x = "Match Number",
    y = "Elo Rating",
    color = "Player"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11, color = "gray30"),
    legend.position = "right",
    panel.grid.minor = element_blank()
  )
```

### Match Activity Summary

```{r activity-summary}
#| echo: false

activity_summary <- players %>%
  mutate(
    Total_Matches = Wins + Losses,
    Win_Rate = round(Wins / Total_Matches * 100, 1)
  ) %>%
  arrange(desc(Total_Matches)) %>%
  select(Name, Total_Matches, Wins, Losses, Win_Rate) %>%
  slice(1:15)

kable(
  activity_summary,
  caption = "Top 15 Most Active Players (by total matches played)",
  col.names = c("Player", "Total Matches", "Wins", "Losses", "Win Rate (%)")
)
```

### Key Insights from the Simulation

1. **Rankings Changed**: The simulation shows natural movement in the ladder as players compete
2. **Higher-Rated Players Win More**: But upsets still happen, making the system dynamic
3. **Activity Matters**: Players who played more matches had more opportunities to climb or fall
4. **Elo is Self-Correcting**: Over time, ratings stabilize to reflect true skill levels
